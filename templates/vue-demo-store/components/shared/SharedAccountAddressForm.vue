<script setup lang="ts">
import { useVuelidate } from "@vuelidate/core";
import { customValidators } from "@/i18n/utils/i18n-validators";
import { ApiClientError } from "@shopware/api-client";
import type { ApiError } from "@shopware/api-client";
import type { Schemas } from "#shopware";

const { required, minLength, requiredIf } = customValidators();

const { createCustomerAddress, updateCustomerAddress, errorMessageBuilder } =
  useAddress();
const { getStatesForCountry } = useCountries();

const emits = defineEmits<{
  (e: "success"): void;
  (e: "close"): void;
}>();

const props = withDefaults(
  defineProps<{
    address?: Schemas["CustomerAddress"];
    title?: string;
  }>(),
  {
    title: "Account address",
    address: undefined,
  },
);

const { getSalutations } = useSalutations();
const { t } = useI18n();
const { pushError } = useNotifications();

const formData = reactive({
  countryId: props.address?.countryId ?? "",
  countryStateId: props.address?.countryStateId ?? "",
  salutationId: props.address?.salutationId ?? "",
  firstName: props.address?.firstName ?? "",
  lastName: props.address?.lastName ?? "",
  zipcode: props.address?.zipcode ?? "",
  city: props.address?.city ?? "",
  street: props.address?.street ?? "",
  id: props.address?.id ?? "",
});

const invokeSave = async (): Promise<void> => {
  try {
    const saveAddress = formData.id
      ? updateCustomerAddress
      : createCustomerAddress;

    $v.value.$touch();
    const valid = await $v.value.$validate();
    if (valid) {
      await saveAddress(formData as Schemas["CustomerAddress"]);
      emits("success");
    }
  } catch (errors) {
    if (errors instanceof ApiClientError) {
      errors.details.errors.forEach((element: ApiError) => {
        pushError(errorMessageBuilder(element) || t("messages.error"));
      });
    }
  }
};

const firstNameInputElement = ref();
useFocus(firstNameInputElement, { initialValue: true });

const rules = computed(() => ({
  salutationId: {
    required,
  },
  firstName: {
    required,
    minLength: minLength(3),
  },
  lastName: {
    required,
    minLength: minLength(3),
  },
  zipcode: {
    required,
  },
  street: {
    required,
    minLength: minLength(3),
  },
  city: {
    required,
  },
  countryId: {
    required,
  },
  countryStateId: {
    required: requiredIf(() => {
      return !!getStatesForCountry(formData.countryId)?.length;
    }),
  },
}));

const $v = useVuelidate(rules, formData);
</script>

<template>
  <div
    id="modal-headline"
    aria-label="Edit Address"
    class="mt-5 md:mt-0 md:col-span-2"
  >
    <div class="shadow overflow-hidden sm:rounded-md">
      <form
        id="account-address"
        ref="formElement"
        name="account-address"
        method="post"
      >
        <div class="px-4 py-5 bg-white sm:p-6">
          <h3 class="text-2xl border-b pb-3">
            {{ props.title }}
          </h3>
          <div class="grid grid-cols-6 gap-6 mt-8">
            <div class="col-span-6 sm:col-span-6">
              <label
                for="country"
                class="block mb-2 text-sm font-medium text-gray-500"
              >
                {{ $t("form.salutation") }}
              </label>
              <select
                id="salutation"
                v-model="formData.salutationId"
                required
                name="salutation"
                aria-label="Customer salutation"
                autocomplete="off"
                class="mt-1 block w-full py-2.5 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-brand-light focus:border-brand-light sm:text-sm"
                data-testid="account-address-form-salutation-select"
              >
                <option
                  v-for="salutation in getSalutations"
                  :key="salutation.id"
                  :value="salutation.id"
                  data-testid="account-address-form-salutation-select-option"
                >
                  {{ salutation.displayName }}
                </option>
              </select>
              <span
                v-if="$v.salutationId.$error"
                class="pt-1 text-sm text-red-600 focus:ring-brand-primary border-gray-300"
              >
                {{ $v.salutationId.$errors[0].$message }}
              </span>
            </div>
            <div class="col-span-6 sm:col-span-3">
              <label
                for="first-name"
                class="block mb-2 text-sm font-medium text-gray-500"
              >
                {{ $t("form.firstName") }}
              </label>
              <input
                id="first-name"
                ref="firstNameInputElement"
                v-model="formData.firstName"
                type="text"
                required
                name="first-name"
                class="mt-1 block w-full p-2.5 border border-gray-300 text-gray-900 text-sm rounded-md shadow-sm focus:ring-brand-light focus:border-brand-light"
                data-testid="account-address-form-firstname-input"
              />
              <span
                v-if="$v.firstName.$error"
                class="pt-1 text-sm text-red-600 focus:ring-brand-primary border-gray-300"
              >
                {{ $v.firstName.$errors[0].$message }}
              </span>
            </div>

            <div class="col-span-6 sm:col-span-3">
              <label
                for="last-name"
                class="block mb-2 text-sm font-medium text-gray-500"
              >
                {{ $t("form.lastName") }}
              </label>
              <input
                id="last-name"
                v-model="formData.lastName"
                type="text"
                required
                name="last-name"
                class="mt-1 block w-full p-2.5 border border-gray-300 text-gray-900 text-sm rounded-md shadow-sm focus:ring-brand-light focus:border-brand-light"
                data-testid="account-address-form-lastname-input"
              />
              <span
                v-if="$v.lastName.$error"
                class="pt-1 text-sm text-red-600 focus:ring-brand-primary border-gray-300"
              >
                {{ $v.lastName.$errors[0].$message }}
              </span>
            </div>

            <SharedCountryStateInput
              v-model:countryId="formData.countryId"
              v-model:stateId="formData.countryStateId"
              :country-id-validation="$v.countryId"
              :state-id-validation="$v.countryStateId"
              class="col-span-6 sm:col-span-6"
            />
            <div class="col-span-6">
              <label
                for="street-address"
                class="block mb-2 text-sm font-medium text-gray-500"
              >
                {{ $t("form.streetAddress") }}
              </label>
              <input
                id="street-address"
                v-model="formData.street"
                type="text"
                required
                name="street-address"
                autocomplete="street-address"
                class="mt-1 block w-full p-2.5 border border-gray-300 text-gray-900 text-sm rounded-md shadow-sm focus:ring-brand-light focus:border-brand-light"
                data-testid="account-address-form-street-input"
              />
              <span
                v-if="$v.street.$error"
                class="pt-1 text-sm text-red-600 focus:ring-brand-primary border-gray-300"
              >
                {{ $v.street.$errors[0].$message }}
              </span>
            </div>

            <div class="col-span-6 sm:col-span-6 lg:col-span-4">
              <label
                for="city"
                class="block mb-2 text-sm font-medium text-gray-500"
              >
                {{ $t("form.city") }}
              </label>
              <input
                id="city"
                v-model="formData.city"
                type="text"
                required
                name="city"
                autocomplete="address-level2"
                class="mt-1 block w-full p-2.5 border border-gray-300 text-gray-900 text-sm rounded-md shadow-sm focus:ring-brand-light focus:border-brand-light"
                data-testid="account-address-form-city-input"
              />
              <span
                v-if="$v.city.$error"
                class="pt-1 text-sm text-red-600 focus:ring-brand-primary border-gray-300"
              >
                {{ $v.city.$errors[0].$message }}
              </span>
            </div>
            <div class="col-span-6 sm:col-span-3 lg:col-span-2">
              <label
                for="postal-code"
                class="block mb-2 text-sm font-medium text-gray-500"
              >
                {{ $t("form.postalCode") }}
              </label>
              <input
                id="postal-code"
                v-model="formData.zipcode"
                type="text"
                required
                name="postal-code"
                autocomplete="postal-code"
                class="mt-1 block w-full p-2.5 border border-gray-300 text-gray-900 text-sm rounded-md shadow-sm focus:ring-brand-light focus:border-brand-light"
                data-testid="account-address-form-postal-code-input"
              />
              <span
                v-if="$v.zipcode.$error"
                class="pt-1 text-sm text-red-600 focus:ring-brand-primary border-gray-300"
              >
                {{ $v.zipcode.$errors[0].$message }}
              </span>
            </div>
          </div>
        </div>
        <div class="px-4 py-3 bg-gray-50 text-right sm:px-6">
          <button
            type="submit"
            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-primary hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-light"
            data-testid="account-address-form-submit-button"
            @click.stop.prevent="invokeSave"
          >
            {{ $t("form.save") }}
          </button>
        </div>
      </form>
    </div>
  </div>
</template>
